{% load static %}
{% load format_price %}
<!-- CONSTRUCCION DE CARD -->
<div
  class="flip-card w-full max-w-lg sm:max-w-lg"
  {% if p.imagen %}style="--card-image: url('{{ p.imagen.url }}');"{% endif %}
  data-perfume-id="{{ p.id }}"
  data-perfume-nombre="{{ p.nombre }}"
  data-perfume-marca="{{ p.marca.marca }}"
  data-perfume-precio="{{ p.precio|default_if_none:0 }}"
  data-perfume-tienda="{{ p.tienda }}"
  data-perfume-url="{{ p.url_producto }}"
  {% if p.imagen %}data-perfume-imagen="{{ p.imagen.url }}"{% endif %}>
  <div class="flip-card-inner">

    <!-- CARA FRONTAL -->
    <div class="flip-card-front card relative">
      <div class="card-body">
        <!-- DESCUENTO CARD -->
        {% if p.descuento %}
        <div class="absolute top-4 left-3">
          <div class="flex">
            <span class="bg-emerald-200 text-emerald-700 text-xs font-Lexend font-bold px-2 py-1 rounded">
              -{{ p.descuento }}% Desc
            </span>
          </div>
        </div>
        {% endif %}

        <!-- LOGO TIENDA -->
        <a href="{{ p.url_producto }}"
          class="inline-block self-center transition-transform duration-200 hover:scale-110"
          target="_blank">
          {% if p.tienda == "SILK" %}
          <img src="{% static 'assets/silk_perfumes.png' %}" alt="Silk Perfumes" class="h-6 w-auto text-center" style="height: 2rem;">
          {% elif p.tienda == "YAURAS" %}
          <img src="{% static 'assets/yauras_perfumes.png' %}" alt="Yauras Perfumes" class="h-6 w-auto" style="height: 3rem;">
          {% elif p.tienda == "JOY" %}
          <img src="{% static 'assets/joy_perfumes.png' %}" alt="Joy Perfumes" class="h-6 w-auto" style="height: 2rem;">
          {% endif %}
        </a>

        <!-- IMAGEN DE CARD -->
        {% if p.imagen %}
        <img src="{{ p.imagen.url }}" alt="{{ p.nombre }}" class="card-image">
        {% endif %}

        <!-- MARCA DE CARD -->
        <div class="mt-2 px-4 leading-2 text-sm text-left font-Lexend text-gray-600 wrap-break-word">
          {{ p.marca.marca }}
        </div>

        <!-- NOMBRE DE CARD -->
        <div class="px-4 py-1 mb-2 leading-5 text-xl text-left font-Poppins uppercase font-bold text-gray-800 wrap-break-word">
          {{ p.nombre }}
        </div>

        <!-- PRECIO DEL PERFUME -->
        <div class="px-4 mt-2">
          <div class="flex justify-center items-center gap-2">
            <span class="text-2xl font-Alexandria  text-amber-600">
              ${{ p.precio|clp }}
            </span>
            {% if p.precio_ant and p.precio_ant > p.precio %}
            <span class="text-lg font-Alexandria font-light line-through text-gray-500 translate-x-2">
              ${{ p.precio_ant|clp }}
            </span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- BOTON COMPARAR -->
      <div class="compare-section">
        <button type="button"
          class="compare-btn text-xs bg-gray-400 cursor-pointer font-Lexend px-4 py-2 rounded-full">
          Agregar para comparar +
        </button>
      </div>
    </div>

    <!-- CARA TRASERA -->
    <div class="flip-card-back card relative from-slate-50/80 via-white to-emerald-50/40 backdrop-blur">
      <div class="text-center flex flex-col items-center gap-2 px-1 sm:px-2">
        <div class="text-xs font-Lexend text-gray-500 tracking-wide">{{ p.marca.marca }}</div>
        <div class="text-lg font-Poppins uppercase font-bold text-slate-800 leading-tight">
          {{ p.nombre }}
        </div>

        <!-- ACORDES -->
        {% if p.acordes.count > 0 %}
        <div class="acordes-wrapper mt-2 w-full">
          <p class="acordes-title text-[11px] font-Lexend font-semibold mb-2 tracking-[0.2em] text-gray-800 uppercase">
            Acordes principales
          </p>
          <div class="acordes-tags flex flex-wrap justify-center gap-2">
            {% for acorde in p.acordes.all %}
            <span
              class="acorde-chip inline-flex items-center justify-center text-[10px] font-Lexend font-semibold px-3 py-0.5 rounded-full border shadow-sm text-gray-900"
              {% if acorde.background_rgb %}
                style="background-color: rgba({{ acorde.background_rgb }}, 0.4); border-color: rgba({{ acorde.background_rgb }}, 3);"
              {% endif %}>
              {{ acorde.nombre }}
            </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- NOTAS OLFATIVAS -->
        {% if p.notas_salida.count > 0 or p.notas_corazon.count > 0 or p.notas_base.count > 0 %}
        <div
          class="notas-piramide w-full -mx-2 sm:-mx-3 px-1 sm:px-2 py-2 border border-white/30 rounded-2xl bg-transparent max-h-60 overflow-y-auto pr-1">
          <p class="text-[11px] font-Lexend font-semibold tracking-[0.3em] text-gray-900 uppercase mb-1">
            Piramide olfativa
          </p>
          {% if p.notas_salida.count > 0 %}
          <div class="nota-section">
            <span class="nota-title text-amber-600">Notas de Salida</span>
            <div class="nota-tags">
              {% for nota in p.notas_salida.all %}
              <span class="nota-chip nota-chip-salida">{{ nota.nombre }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% if p.notas_corazon.count > 0 %}
          <div class="nota-section">
            <span class="nota-title mt-1 text-rose-500">Notas de Corazón</span>
            <div class="nota-tags">
              {% for nota in p.notas_corazon.all %}
              <span class="nota-chip nota-chip-corazon">{{ nota.nombre }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% if p.notas_base.count > 0 %}
          <div class="nota-section">
            <span class="nota-title mt-1 text-emerald-600">Notas Base</span>
            <div class="nota-tags">
              {% for nota in p.notas_base.all %}
              <span class="nota-chip nota-chip-base">{{ nota.nombre }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>

      {% if p.acordes.count == 0 and p.notas_salida.count == 0 and p.notas_corazon.count == 0 and p.notas_base.count == 0 %}
      <div class="download-wrapper mt-6">
        <form method="post" action="{% url 'descargar_acordes_individual' p.id %}" class="js-download-form">
          {% csrf_token %}
          <button type="submit" class="download-btn js-download-btn">
            Descargar detalles
          </button>
          <p class="mt-2 text-xs text-slate-500 js-download-status hidden"></p>
        </form>
      </div>
      {% endif %}

      <!-- ESTACIONES -->
      <div class="w-full text-center">
        <p class="mb-2 text-[11px] font-Lexend font-bold text-gray-800 uppercase">Estaciones</p>
        {% if p.estaciones.count %}
        <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
          {% for estacion in p.estaciones.all %}
          {% with nombre=estacion.nombre|default_if_none:"" slug=estacion.nombre|default_if_none:""|slugify percent=estacion.porcentaje|default_if_none:0 %}
          {% if "invierno" in slug %}
          {% with icon="fa-snowflake" color="#4fb7e9" label="Invierno" %}
          <div class="flex flex-col items-center gap-1 font-Lexend text-slate-800">
            <div class="relative flex h-16 w-16 items-center justify-center rounded-full p-1 shadow-[0_4px_12px_rgba(15,23,42,0.12)] ring-1 ring-slate-200/70"
              style="background: conic-gradient({{ color }} {{ percent }}%, rgba(148,163,184,0.25) 0);">
              <div class="absolute inset-1 flex items-center justify-center rounded-full bg-white text-lg"
                style="color: {{ color }};">
                <i class="fa-solid {{ icon }}"></i>
              </div>
            </div>
            <span class="text-[10px] uppercase font-semibold text-slate-700">{{ label }}</span>
            <span class="text-xs font-semibold text-slate-500">{{ percent|floatformat:0 }}%</span>
          </div>
          {% endwith %}
          {% elif "primavera" in slug %}
          {% with icon="fa-leaf" color="#5fc873" label="Primavera" %}
          <div class="flex flex-col items-center gap-1 font-Lexend text-slate-800">
            <div class="relative flex h-16 w-16 items-center justify-center rounded-full p-1 shadow-[0_4px_12px_rgba(15,23,42,0.12)] ring-1 ring-slate-200/70"
              style="background: conic-gradient({{ color }} {{ percent }}%, rgba(148,163,184,0.25) 0);">
              <div class="absolute inset-1 flex items-center justify-center rounded-full bg-white text-lg"
                style="color: {{ color }};">
                <i class="fa-solid {{ icon }}"></i>
              </div>
            </div>
            <span class="text-[10px] uppercase font-semibold text-slate-700">{{ label }}</span>
            <span class="text-xs font-semibold text-slate-500">{{ percent|floatformat:0 }}%</span>
          </div>
          {% endwith %}
          {% elif "verano" in slug %}
          {% with icon="fa-sun" color="#f5c04a" label="Verano" %}
          <div class="flex flex-col items-center gap-1 font-Lexend text-slate-800">
            <div class="relative flex h-16 w-16 items-center justify-center rounded-full p-1 shadow-[0_4px_12px_rgba(15,23,42,0.12)] ring-1 ring-slate-200/70"
              style="background: conic-gradient({{ color }} {{ percent }}%, rgba(148,163,184,0.25) 0);">
              <div class="absolute inset-1 flex items-center justify-center rounded-full bg-white text-lg"
                style="color: {{ color }};">
                <i class="fa-solid {{ icon }}"></i>
              </div>
            </div>
            <span class="text-[10px] uppercase font-semibold text-slate-700">{{ label }}</span>
            <span class="text-xs font-semibold text-slate-500">{{ percent|floatformat:0 }}%</span>
          </div>
          {% endwith %}
          {% elif "otono" in slug %}
          {% with icon="fa-cannabis" color="#d39b4e" label="Otoño" %}
          <div class="flex flex-col items-center gap-1 font-Lexend text-slate-800">
            <div class="relative flex h-16 w-16 items-center justify-center rounded-full p-1 shadow-[0_4px_12px_rgba(15,23,42,0.12)] ring-1 ring-slate-200/70"
              style="background: conic-gradient({{ color }} {{ percent }}%, rgba(148,163,184,0.25) 0);">
              <div class="absolute inset-1 flex items-center justify-center rounded-full bg-white text-lg"
                style="color: {{ color }};">
                <i class="fa-solid {{ icon }}"></i>
              </div>
            </div>
            <span class="text-[10px] uppercase font-semibold text-slate-700">{{ label }}</span>
            <span class="text-xs font-semibold text-slate-500">{{ percent|floatformat:0 }}%</span>
          </div>
          {% endwith %}
          {% endif %}
          {% endwith %}
          {% endfor %}
        </div>
        {% else %}
        <p class="text-xs text-gray-500">Sin datos disponibles</p>
        {% endif %}
      </div>

      <!-- BOTON COMPARAR REVERSO -->
      <div class="compare-section">
        <button type="button"
          class="compare-btn text-xs bg-gray-400 cursor-pointer font-Lexend px-4 py-2 rounded-full">
          Agregar para comparar +
        </button>
      </div>
    </div>
  </div>
</div>
<!-- FIN DE CONSTRUCCION DE CARD -->
