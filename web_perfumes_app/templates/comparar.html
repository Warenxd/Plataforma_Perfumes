{% extends 'base.html' %}
{% load static %}

{% block title %}Comparar perfumes{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-100">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-8 space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-[11px] uppercase tracking-[0.35em] text-slate-500">Comparación</p>
        <h1 class="text-2xl sm:text-3xl font-semibold text-slate-900">Tus perfumes seleccionados</h1>
        <p class="text-sm text-slate-600">Se cargan desde los que agregaste en la página principal.</p>
      </div>
      <a href="{% url 'home' %}" class="rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
        ← Volver
      </a>
    </div>

    <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="rounded-full bg-slate-200 px-3 py-1 text-xs font-semibold text-slate-700">Seleccionados:
            <span id="compare-count">0</span>
          </span>
          <button
            id="compare-clear"
            type="button"
            class="rounded-full border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
            Vaciar lista
          </button>
        </div>
        <button
          id="compare-refresh"
          type="button"
          class="text-xs font-semibold text-indigo-600 hover:text-indigo-500">
          Recargar lista
        </button>
      </div>
      <div class="overflow-auto">
        <table class="w-full">
          <thead class="bg-slate-50 border-b border-slate-200 text-left text-[11px] uppercase tracking-[0.08em] text-slate-500">
            <tr>
              <th class="px-4 py-3">Perfume</th>
              <th class="px-4 py-3 whitespace-nowrap">Cantidad</th>
              <th class="px-4 py-3 whitespace-nowrap">Precio</th>
              <th class="px-4 py-3 whitespace-nowrap">Total</th>
              <th class="px-4 py-3 whitespace-nowrap">Precio venta</th>
              <th class="px-4 py-3 whitespace-nowrap">Ganancia</th>
              <th class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody id="compare-body">
            <tr>
              <td colspan="7" class="text-center text-slate-500 py-5 text-sm">
                Aún no agregas perfumes para comparar.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="border-t border-slate-200 bg-slate-50 px-4 py-3 flex flex-wrap items-center justify-end gap-3 text-sm font-semibold">
        <span class="inline-flex items-center gap-2 rounded-full bg-slate-200 px-3 py-1 text-slate-800">
          <span class="h-2 w-2 rounded-full bg-slate-500"></span>
          Total compra: <span id="summary-compra">$0</span>
        </span>
        <span class="inline-flex items-center gap-2 rounded-full bg-indigo-100 px-3 py-1 text-indigo-700">
          <span class="h-2 w-2 rounded-full bg-indigo-500"></span>
          Total venta: <span id="summary-venta">$0</span>
        </span>
        <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 bg-emerald-100 text-emerald-700" id="summary-ganancia-wrapper">
          <span class="h-2 w-2 rounded-full bg-emerald-500" id="summary-ganancia-dot"></span>
          Ganancia total: <span id="summary-ganancia">$0</span>
        </span>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = "perfumes_comparar";
  const body = document.getElementById("compare-body");
  const countEl = document.getElementById("compare-count");
  const clearBtn = document.getElementById("compare-clear");
  const refreshBtn = document.getElementById("compare-refresh");
  const summaryCompra = document.getElementById("summary-compra");
  const summaryVenta = document.getElementById("summary-venta");
  const summaryGanancia = document.getElementById("summary-ganancia");

  const formatPriceCLP = (value) => {
    const number = Number(value) || 0;
    try {
      return new Intl.NumberFormat("es-CL", {
        style: "currency",
        currency: "CLP",
        maximumFractionDigits: 0,
      }).format(number);
    } catch (error) {
      return `$${number.toLocaleString("es-CL")}`;
    }
  };

  const loadItems = () => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(parsed)) {
        return [];
      }
      return parsed.map((item) => ({
        ...item,
        cantidad: Number(item.cantidad) >= 0 ? Number(item.cantidad) : 0,
        precio_venta: Number(item.precio_venta) || 0,
        decants: Array.isArray(item.decants)
          ? item.decants.map((d, idx) => ({
              id: d.id || `d-${idx}-${Date.now()}`,
              ml: Number(d.ml) || 0,
              precio: Number(d.precio) || 0,
              cantidad: Number(d.cantidad) >= 0 ? Number(d.cantidad) : 1,
            }))
          : [],
      }));
    } catch (error) {
      console.warn("No se pudo leer la lista", error);
      return [];
    }
  };

  const saveItems = (items) => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    } catch (error) {
      console.warn("No se pudo guardar la lista", error);
    }
  };

  const updateItem = (id, data) => {
    const items = loadItems();
    const next = items.map((item) => {
      if (String(item.id) !== String(id)) {
        return item;
      }
      return { ...item, ...data };
    });
    saveItems(next);
    render();
  };

  const render = () => {
    const items = loadItems();
    body.innerHTML = "";
    let totalCompraGeneral = 0;
    let totalVentaGeneral = 0;
    let totalGananciaGeneral = 0;
    if (items.length === 0) {
      body.innerHTML = '<tr><td colspan="7" class="text-center text-slate-500 py-5 text-sm">Aún no agregas perfumes para comparar.</td></tr>';
    } else {
      items.forEach((item) => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-slate-100 last:border-0";

        const tdPerfume = document.createElement("td");
        tdPerfume.className = "px-4 py-3";
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-center gap-3";
        const thumb = document.createElement("div");
        thumb.className = "h-12 w-12 rounded-xl border border-slate-200 bg-slate-100 flex items-center justify-center overflow-hidden";
        if (item.imagen) {
          const img = document.createElement("img");
          img.src = item.imagen;
          img.alt = item.nombre || "";
          img.className = "h-full w-full object-cover";
          thumb.appendChild(img);
        } else {
          thumb.textContent = "N/A";
          thumb.classList.add("text-xs", "text-slate-500");
        }
        const info = document.createElement("div");
        info.className = "leading-tight";
        const name = document.createElement("p");
        name.className = "text-sm font-semibold text-slate-800";
        name.textContent = item.nombre || "Perfume";
        const brand = document.createElement("p");
        brand.className = "text-xs text-slate-500";
        brand.textContent = item.marca || "";
        info.append(name, brand);
        wrapper.append(thumb, info);
        tdPerfume.appendChild(wrapper);

        const tdCantidad = document.createElement("td");
        tdCantidad.className = "px-4 py-3 whitespace-nowrap";
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "0";
        qtyInput.step = "1";
        qtyInput.value = Number.isFinite(item.cantidad) ? item.cantidad : 0;
        qtyInput.className = "w-20 rounded-lg border border-slate-300 px-2 py-1 text-sm text-slate-700";
        qtyInput.addEventListener("change", () => {
          const value = Number(qtyInput.value);
          updateItem(item.id, { cantidad: value >= 0 ? value : 0 });
        });
        tdCantidad.appendChild(qtyInput);

        const tdPrecio = document.createElement("td");
        tdPrecio.className = "px-4 py-3 whitespace-nowrap text-sm font-semibold text-slate-800";
        tdPrecio.textContent = formatPriceCLP(item.precio);

        const tdTotal = document.createElement("td");
        tdTotal.className = "px-4 py-3 whitespace-nowrap text-sm font-semibold text-slate-800";
        const qtyNumber = Number(item.cantidad) || 0;
        const precioUnit = Number(item.precio) || 0;
        const totalCompra = precioUnit * qtyNumber;
        tdTotal.textContent = formatPriceCLP(totalCompra);

        const tdVenta = document.createElement("td");
        tdVenta.className = "px-4 py-3 whitespace-nowrap";
        const ventaInput = document.createElement("input");
        ventaInput.type = "number";
        ventaInput.min = "0";
        ventaInput.step = "1000";
        ventaInput.value = item.precio_venta || "";
        ventaInput.placeholder = "Precio venta";
        ventaInput.className = "w-28 rounded-lg border border-slate-300 px-2 py-1 text-sm text-slate-700";
        ventaInput.addEventListener("change", () => {
          const value = Number(ventaInput.value);
          updateItem(item.id, { precio_venta: value >= 0 ? value : 0 });
        });
        tdVenta.appendChild(ventaInput);

        const tdGanancia = document.createElement("td");
        tdGanancia.className = "px-4 py-3 whitespace-nowrap text-sm font-semibold";
        const ventaPerfumeTotal = (Number(item.precio_venta) || 0) * qtyNumber;
        const ingresoDecants = (item.decants || []).reduce((acc, d) => {
          const cantidadDecant = Number(d.cantidad) || 0;
          const precioDecant = Number(d.precio) || 0;
          return acc + cantidadDecant * precioDecant;
        }, 0);
        const ventaTotal = ventaPerfumeTotal + ingresoDecants;
        const gananciaPerfume = qtyNumber > 0 ? ventaPerfumeTotal - totalCompra : 0;
        const gananciaDecants = ingresoDecants - (precioUnit * qtyNumber > 0 ? 0 : 0); // asumimos costo 0 adicional si solo decants
        const ganancia = gananciaPerfume + gananciaDecants;
        tdGanancia.textContent = formatPriceCLP(ganancia);
        tdGanancia.classList.add(ganancia >= 0 ? "text-emerald-600" : "text-rose-600");

        let decantRow;
        const tdAcciones = document.createElement("td");
        tdAcciones.className = "px-4 py-3 text-right whitespace-nowrap";
        const actions = document.createElement("div");
        actions.className = "flex justify-end gap-2";
        const decantToggle = document.createElement("button");
        decantToggle.type = "button";
        decantToggle.className =
          "inline-flex items-center gap-1 rounded-full border border-slate-300 bg-white px-3 py-1 text-[11px] font-semibold text-slate-700 shadow-sm hover:bg-slate-50";
        decantToggle.innerHTML = '<i class="fa-solid fa-flask"></i><span>Decants</span>';
        decantToggle.addEventListener("click", () => {
          if (!decantRow) {
            return;
          }
          const isHidden = decantRow.classList.toggle("hidden");
          decantToggle.innerHTML = isHidden
            ? '<i class="fa-solid fa-flask"></i><span>Decants</span>'
            : '<i class="fa-solid fa-flask"></i><span>Decants ▲</span>';
        });
        actions.appendChild(decantToggle);
        if (item.url) {
          const view = document.createElement("a");
          view.href = item.url;
          view.target = "_blank";
          view.rel = "noopener";
          view.className =
            "inline-flex items-center gap-1 rounded-full bg-indigo-600 px-3 py-1 text-[11px] font-semibold text-white shadow-sm hover:bg-indigo-500";
          view.innerHTML = '<i class="fa-solid fa-up-right-from-square"></i><span>Ver</span>';
          actions.appendChild(view);
        }
        const remove = document.createElement("button");
        remove.type = "button";
        remove.className =
          "inline-flex items-center gap-1 rounded-full bg-rose-100 px-3 py-1 text-[11px] font-semibold text-rose-700 shadow-sm hover:bg-rose-200";
        remove.innerHTML = '<i class="fa-solid fa-xmark"></i><span>Quitar</span>';
        remove.addEventListener("click", () => {
          const next = loadItems().filter((p) => String(p.id) !== String(item.id));
          saveItems(next);
          render();
        });
        actions.appendChild(remove);
        tdAcciones.appendChild(actions);

        tr.append(tdPerfume, tdCantidad, tdPrecio, tdTotal, tdVenta, tdGanancia, tdAcciones);
        body.appendChild(tr);

        totalCompraGeneral += totalCompra;
        totalVentaGeneral += ventaTotal;
        totalGananciaGeneral += ganancia;

        // Fila extra para decants
        decantRow = document.createElement("tr");
        decantRow.className = "border-b border-slate-100 last:border-0 bg-slate-50/40";
        const decantCell = document.createElement("td");
        decantCell.colSpan = 7;
        decantCell.className = "px-4 py-3";

        const decantHeader = document.createElement("div");
        decantHeader.className = "flex items-center justify-between gap-3";
        const decantTitle = document.createElement("p");
        decantTitle.className = "text-xs font-semibold text-slate-700 uppercase tracking-[0.08em]";
        decantTitle.textContent = "Decants (opcional)";
        decantHeader.appendChild(decantTitle);
        decantCell.appendChild(decantHeader);

        const decantList = document.createElement("div");
        decantList.className = "mt-2 space-y-1";

        const renderDecants = () => {
          decantList.innerHTML = "";
          if (!item.decants || item.decants.length === 0) {
            const empty = document.createElement("p");
            empty.className = "text-xs text-slate-500";
            empty.textContent = "Sin decants registrados.";
            decantList.appendChild(empty);
            return;
          }
          item.decants.forEach((d) => {
            const row = document.createElement("div");
            row.className = "flex flex-col gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2";
            const top = document.createElement("div");
            top.className = "flex items-center justify-between gap-2";
            const left = document.createElement("div");
            left.className = "text-sm text-slate-800";
            left.textContent = `${d.ml || 0} ml · ${formatPriceCLP(d.precio || 0)}`;
            const right = document.createElement("div");
            right.className = "flex items-center gap-2";
            const gain = document.createElement("span");
            const compraUnit = Number(item.precio) || 0;
            const qty = Number(item.cantidad) || 0;
            const compraTotal = compraUnit * qty;
            const ventaDecant = (Number(d.precio) || 0) * (Number(d.cantidad) || 0);
            const compraEstimado = compraTotal > 0 ? (compraTotal / (qty || 1)) * (Number(d.ml) || 0) / 100 * (Number(d.cantidad) || 0) : 0;
            const gananciaDecant = ventaDecant - compraEstimado;
            gain.className = "text-xs font-semibold " + (gananciaDecant >= 0 ? "text-emerald-600" : "text-rose-600");
            gain.textContent = gananciaDecant ? `${gananciaDecant >= 0 ? "+" : ""}${formatPriceCLP(gananciaDecant)}` : "";
            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "text-[11px] font-semibold text-rose-600 hover:text-rose-500";
            removeBtn.textContent = "Quitar";
            removeBtn.addEventListener("click", () => {
              const nextItems = loadItems().map((p) => {
                if (String(p.id) !== String(item.id)) return p;
                return {
                  ...p,
                  decants: (p.decants || []).filter((x) => x.id !== d.id),
                };
              });
              saveItems(nextItems);
              render();
            });
            right.appendChild(gain);
            right.appendChild(removeBtn);
            top.append(left, right);

            const bottom = document.createElement("div");
            bottom.className = "flex flex-wrap items-center gap-2 text-xs text-slate-600";
            const qtyLabel = document.createElement("span");
            qtyLabel.textContent = "Cantidad:";
            const qtyInput = document.createElement("input");
            qtyInput.type = "number";
            qtyInput.min = "0";
            qtyInput.step = "1";
            qtyInput.value = Number.isFinite(d.cantidad) ? d.cantidad : 1;
            qtyInput.className = "w-20 rounded-lg border border-slate-300 px-2 py-1 text-xs text-slate-700";
            qtyInput.addEventListener("change", () => {
              const value = Number(qtyInput.value);
              const nextItems = loadItems().map((p) => {
                if (String(p.id) !== String(item.id)) return p;
                const decants = (p.decants || []).map((x) =>
                  x.id === d.id ? { ...x, cantidad: value >= 0 ? value : 0 } : x
                );
                return { ...p, decants };
              });
              saveItems(nextItems);
              render();
            });
            bottom.append(qtyLabel, qtyInput);

            row.append(top, bottom);
            decantList.appendChild(row);
          });
        };
        renderDecants();

        const decantForm = document.createElement("div");
        decantForm.className = "mt-3 flex flex-wrap items-center gap-2";
        const mlInput = document.createElement("input");
        mlInput.type = "number";
        mlInput.min = "1";
        mlInput.step = "1";
        mlInput.placeholder = "ml";
        mlInput.className = "w-20 rounded-lg border border-slate-300 px-2 py-1 text-sm text-slate-700";
        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.min = "0";
        priceInput.step = "100";
        priceInput.placeholder = "Precio";
        priceInput.className = "w-28 rounded-lg border border-slate-300 px-2 py-1 text-sm text-slate-700";
        const addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.className =
          "inline-flex items-center gap-1 rounded-full bg-indigo-600 px-3 py-1 text-[11px] font-semibold text-white shadow-sm hover:bg-indigo-500";
        addBtn.innerHTML = '<i class="fa-solid fa-plus"></i><span>Agregar decant</span>';
        addBtn.addEventListener("click", () => {
          const mlVal = Number(mlInput.value);
          const priceVal = Number(priceInput.value);
          if (!mlVal || mlVal <= 0) {
            mlInput.focus();
            return;
          }
          const nextItems = loadItems().map((p) => {
            if (String(p.id) !== String(item.id)) return p;
            const decants = Array.isArray(p.decants) ? [...p.decants] : [];
            decants.push({
              id: `d-${Date.now()}`,
              ml: mlVal,
              precio: priceVal >= 0 ? priceVal : 0,
            });
            return { ...p, decants };
          });
          saveItems(nextItems);
          render();
        });
        decantForm.append(mlInput, priceInput, addBtn);

        decantCell.append(decantList, decantForm);
        decantRow.appendChild(decantCell);
        body.appendChild(decantRow);

        const syncDecantToggle = () => {
          if (!decantRow || !decantToggle) {
            return;
          }
          const hidden = decantRow.classList.contains("hidden");
          decantToggle.innerHTML = hidden
            ? '<i class="fa-solid fa-flask"></i><span>Decants</span>'
            : '<i class="fa-solid fa-flask"></i><span>Decants ▲</span>';
        };
        const hasDecants = item.decants && item.decants.length > 0;
        decantRow.classList.toggle("hidden", !hasDecants);
        syncDecantToggle();
      });
    }
    if (countEl) {
      countEl.textContent = items.length;
    }
    if (summaryCompra && summaryVenta && summaryGanancia) {
      summaryCompra.textContent = formatPriceCLP(totalCompraGeneral);
      summaryVenta.textContent = formatPriceCLP(totalVentaGeneral);
      summaryGanancia.textContent = formatPriceCLP(totalGananciaGeneral);
      const gananciaWrapper = document.getElementById("summary-ganancia-wrapper");
      const gananciaDot = document.getElementById("summary-ganancia-dot");
      if (gananciaWrapper && gananciaDot) {
        const positive = totalGananciaGeneral >= 0;
        gananciaWrapper.className =
          "inline-flex items-center gap-2 rounded-full px-3 py-1 " +
          (positive ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700");
        gananciaDot.className =
          "h-2 w-2 rounded-full " + (positive ? "bg-emerald-500" : "bg-rose-500");
      }
    }
  };

  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      saveItems([]);
      render();
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener("click", render);
  }

  render();
})();
</script>
{% endblock %}
